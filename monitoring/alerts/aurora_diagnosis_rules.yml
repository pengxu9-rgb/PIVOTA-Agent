groups:
  - name: aurora-diagnosis-recording
    interval: 1m
    rules:
      - record: aurora:quality_fail_rate:15m
        expr: |
          sum(rate(analyze_requests_total{quality_grade="fail"}[15m]))
          /
          clamp_min(sum(rate(analyze_requests_total[15m])), 1)

      - record: aurora:quality_degraded_rate:15m
        expr: |
          sum(rate(analyze_requests_total{quality_grade="degraded"}[15m]))
          /
          clamp_min(sum(rate(analyze_requests_total[15m])), 1)

      - record: aurora:geometry_sanitizer_drop_rate:15m
        expr: |
          sum by (issue_type, quality_grade, pipeline_version, device_class) (
            rate(geometry_sanitizer_drop_total[15m])
          )
          /
          clamp_min(
            sum by (issue_type, quality_grade, pipeline_version, device_class) (
              rate(analyze_requests_total[15m])
            ),
            1
          )

      - record: aurora:verify_budget_guard_count:15m
        expr: increase(verify_budget_guard_total[15m])

      - record: aurora:skin_reco_request_rate:15m
        expr: |
          sum(rate(aurora_skin_flow_total{stage="reco_request",outcome="hit"}[15m]))

      - record: aurora:skin_reco_generated_rate:15m
        expr: |
          sum(rate(aurora_skin_flow_total{stage="reco_generated",outcome="hit"}[15m]))
          /
          clamp_min(aurora:skin_reco_request_rate:15m, 0.000001)

      - record: aurora:skin_low_confidence_rate:15m
        expr: |
          sum(rate(aurora_skin_flow_total{stage="reco_low_confidence",outcome="hit"}[15m]))
          /
          clamp_min(aurora:skin_reco_request_rate:15m, 0.000001)

      - record: aurora:skin_safety_block_rate:15m
        expr: |
          sum(rate(aurora_skin_flow_total{stage="reco_safety_block",outcome="hit"}[15m]))
          /
          clamp_min(aurora:skin_reco_request_rate:15m, 0.000001)

      - record: aurora:chat_proxy_fallback_rate:5m
        expr: |
          (
            sum(rate(aurora_chat_proxy_fallback_total[5m]))
            /
            clamp_min(sum(rate(aurora_chat_proxy_requests_total[5m])), 1)
          )
          or on() vector(0)

  - name: aurora-diagnosis-alerts
    interval: 1m
    rules:
      - alert: AuroraHttp5xxRateHigh
        expr: |
          (
            sum(rate(pivota_http_requests_total{status_class="5xx"}[5m]))
            /
            clamp_min(sum(rate(pivota_http_requests_total[5m])), 1)
          ) > 0.02
        for: 10m
        labels:
          severity: critical
          service: pivota-agent-backend
          team: aurora
        annotations:
          summary: "Aurora backend 5xx rate is high"
          description: "5xx rate stayed above 2% for 10m. Check upstream and release diff."
          runbook: "docs/MONITORING_RUNBOOK.md"

      - alert: AuroraHttpTimeoutRateHigh
        expr: |
          (
            sum(rate(pivota_http_timeouts_total[5m]))
            /
            clamp_min(sum(rate(pivota_http_requests_total[5m])), 1)
          ) > 0.01
        for: 10m
        labels:
          severity: warning
          service: pivota-agent-backend
          team: aurora
        annotations:
          summary: "Aurora backend timeout rate is elevated"
          description: "HTTP timeout rate exceeded 1% for 10m. Check upstream latency and timeout budgets."
          runbook: "docs/MONITORING_RUNBOOK.md"

      - alert: AuroraVerifyFailSpike
        expr: increase(verify_fail_total[15m]) > 20
        for: 5m
        labels:
          severity: warning
          service: pivota-agent-backend
          team: aurora
        annotations:
          summary: "Gemini shadow verifier failures spiked"
          description: "More than 20 verifier failures in 15m. Inspect reason breakdown in dashboard."
          runbook: "docs/MONITORING_RUNBOOK.md"

      - alert: AuroraVerifyBudgetGuardTriggered
        expr: aurora:verify_budget_guard_count:15m > 0
        for: 2m
        labels:
          severity: warning
          service: pivota-agent-backend
          team: aurora
        annotations:
          summary: "Gemini shadow verifier hit budget guard"
          description: "Verifier calls were skipped by DIAG_VERIFY_MAX_CALLS_PER_MIN or DIAG_VERIFY_MAX_CALLS_PER_DAY."
          runbook: "docs/MONITORING_RUNBOOK.md"

      - alert: AuroraQualityFailRateSpike
        expr: aurora:quality_fail_rate:15m > 0.35
        for: 30m
        labels:
          severity: warning
          service: pivota-agent-backend
          team: aurora
        annotations:
          summary: "Photo quality fail rate spike"
          description: "quality_fail_rate exceeded 35% over 15m window. Check camera guidance and upload path."
          runbook: "docs/MONITORING_RUNBOOK.md"

      - alert: AuroraGeometryDropRateSpike
        expr: max by () (aurora:geometry_sanitizer_drop_rate:15m) > 0.20
        for: 30m
        labels:
          severity: warning
          service: pivota-agent-backend
          team: aurora
        annotations:
          summary: "Geometry sanitizer drop-rate spike"
          description: "geometry_sanitizer_drop_rate crossed 20%. Validate sanitizer thresholds and upstream geometry quality."
          runbook: "docs/MONITORING_RUNBOOK.md"

      - alert: AuroraSkinRecoGeneratedRateLow
        expr: |
          aurora:skin_reco_request_rate:15m > 0.02
          and
          aurora:skin_reco_generated_rate:15m < 0.35
        for: 20m
        labels:
          severity: warning
          service: pivota-agent-backend
          team: aurora
        annotations:
          summary: "Skin reco generated rate dropped"
          description: "reco_generated_rate stayed below 35% with meaningful reco volume. Check artifact/reco gates and matcher output."
          runbook: "docs/MONITORING_RUNBOOK.md"

      - alert: AuroraSkinLowConfidenceRateHigh
        expr: |
          aurora:skin_reco_request_rate:15m > 0.02
          and
          aurora:skin_low_confidence_rate:15m > 0.55
        for: 30m
        labels:
          severity: warning
          service: pivota-agent-backend
          team: aurora
        annotations:
          summary: "Skin low-confidence rate elevated"
          description: "low_confidence_rate stayed above 55%. Check photo QC, gating, and analysis fallback distribution."
          runbook: "docs/MONITORING_RUNBOOK.md"

      - alert: AuroraSkinSafetyBlockRateHigh
        expr: |
          aurora:skin_reco_request_rate:15m > 0.02
          and
          aurora:skin_safety_block_rate:15m > 0.18
        for: 15m
        labels:
          severity: warning
          service: pivota-agent-backend
          team: aurora
        annotations:
          summary: "Skin safety-block rate elevated"
          description: "safety_block_rate stayed above 18%. Verify red-flag parser drift and message normalization."
          runbook: "docs/MONITORING_RUNBOOK.md"

      - alert: AuroraChatProxyFallbackRateHigh
        expr: aurora:chat_proxy_fallback_rate:5m > 0.05
        for: 10m
        labels:
          severity: warning
          service: aurora-chat-proxy
          team: aurora
        annotations:
          summary: "Chat proxy fallback rate elevated"
          description: "proxy.fallback_rate stayed above 5%. Check client /api/chat proxy path and BFF availability."
          runbook: "docs/MONITORING_RUNBOOK.md"

      - alert: AuroraRecoTimeoutDegradedRateHigh
        expr: |
          aurora:skin_reco_request_rate:15m > 0.02
          and
          aurora_skin_reco_timeout_degraded_rate > 0.01
        for: 10m
        labels:
          severity: warning
          service: pivota-agent-backend
          team: aurora
        annotations:
          summary: "Reco timeout-degraded rate elevated"
          description: "reco timeout_degraded_rate stayed above 1%. Check upstream p95/p99 latency and transient network failures."
          runbook: "docs/MONITORING_RUNBOOK.md"

      - alert: AuroraAnalysisTimeoutDegradedRateHigh
        expr: |
          increase(aurora_skin_flow_total{stage="analysis_request",outcome="hit"}[15m]) > 20
          and
          aurora_skin_analysis_timeout_degraded_rate > 0.01
        for: 10m
        labels:
          severity: warning
          service: pivota-agent-backend
          team: aurora
        annotations:
          summary: "Analysis timeout-degraded rate elevated"
          description: "analysis timeout_degraded_rate stayed above 1%. Check photo fetch/vision latency and upstream instability."
          runbook: "docs/MONITORING_RUNBOOK.md"

      - alert: AuroraRecoOutputGuardFallbackRateHigh
        expr: |
          aurora:skin_reco_request_rate:15m > 0.02
          and
          aurora_skin_reco_output_guard_fallback_rate > 0.001
        for: 10m
        labels:
          severity: warning
          service: pivota-agent-backend
          team: aurora
        annotations:
          summary: "Reco output-guard fallback rate elevated"
          description: "reco_output_guard_fallback_rate stayed above 0.1%. Check upstream recommendation card schema/serialization drift."
          runbook: "docs/MONITORING_RUNBOOK.md"
