name: aurora-rollout-probe

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch: {}

jobs:
  probe:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install
        run: npm ci

      - name: Run probe (production)
        env:
          AURORA_PROBE_BASE_URL: ${{ secrets.AURORA_PROBE_BASE_URL }}
          AURORA_PROBE_WEBHOOK_URL: ${{ secrets.AURORA_PROBE_WEBHOOK_URL }}
          AURORA_PROBE_WEBHOOK_TOKEN: ${{ secrets.AURORA_PROBE_WEBHOOK_TOKEN }}
          AURORA_PROBE_SAMPLES: "20"
          AURORA_PROBE_CONCURRENCY: "5"
          AURORA_PROBE_RETRY_COUNT: "1"
          AURORA_PROBE_WINDOW_MINUTES: "10"
        run: |
          npm run probe:aurora:rollout -- \
            --base "$AURORA_PROBE_BASE_URL" \
            --samples "$AURORA_PROBE_SAMPLES" \
            --concurrency "$AURORA_PROBE_CONCURRENCY" \
            --retry-count "$AURORA_PROBE_RETRY_COUNT" \
            --window-minutes "$AURORA_PROBE_WINDOW_MINUTES" \
            --webhook "$AURORA_PROBE_WEBHOOK_URL" \
            --webhook-token "$AURORA_PROBE_WEBHOOK_TOKEN" \
            --fail-on-high true

      - name: Upload report artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: aurora-rollout-probe-reports
          path: |
            reports/aurora_rollout_probe_*.json
            reports/aurora_rollout_probe_*.md
          retention-days: 7
