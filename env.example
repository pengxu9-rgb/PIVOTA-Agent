# Pivota Agent Gateway Configuration
# Copy this file to .env and fill in your actual values
# NEVER commit .env to version control

# Server Configuration
PORT=3000

# Pivota API Configuration
# Production: https://web-production-fedb.up.railway.app
# Replace with your actual Pivota API endpoint
PIVOTA_API_BASE=http://localhost:8080

# Your Pivota API Key from the Pivota console
# Keep this secret and secure!
PIVOTA_API_KEY=

# OpenAI Configuration (required for /ui/chat endpoint)
# Get your key from https://platform.openai.com/api-keys
OPENAI_API_KEY=

# Gateway Configuration
# The public URL where this gateway is deployed
PIVOTA_GATEWAY_URL=http://localhost:3000/agent/shop/v1/invoke

# Operation Mode
# Options: test, production
# Use 'test' for development with test merchants
# Use 'production' only when ready for real transactions
MODE=test

# API Mode Configuration
# Options: MOCK, HYBRID, REAL
# MOCK: Use internal mock data for all operations (default, good for demos)
# HYBRID: Real product search + mock payment (good for testing)
# REAL: Full real API integration (requires PIVOTA_API_KEY)
API_MODE=MOCK

# Search routing guardrails
# Keep resolver-first for strong alias/UUID lookups; avoid masking catalog recall issues
# on generic shopping queries.
PROXY_SEARCH_RESOLVER_FIRST_STRONG_ONLY=true

# Legacy mock configuration (deprecated, use API_MODE instead)
USE_MOCK=false
MOCK_PIVOTA_PORT=8080

# Optional: Logging Configuration
# Options: debug, info, warn, error
LOG_LEVEL=info

# Optional: Test Merchant Configuration
# Used when MODE=test to avoid real transactions
TEST_MERCHANT_ID=
TEST_AGENT_ID=

# ---------------- Canonical Taxonomy (Creator Categories) ----------------
# Postgres connection string for pivota-agent-backend owned taxonomy + overrides.
DATABASE_URL=

# Optional DB connection tuning
DB_POOL_MAX=5
DB_SSL=false
DB_SSL_REJECT_UNAUTHORIZED=true

# Optional taxonomy knobs
TAXONOMY_VIEW_ID=GLOBAL_FASHION
TAXONOMY_DEFAULT_LOCALE=en-US
TAXONOMY_CACHE_TTL_MS=30000
TAXONOMY_VERSION=GLOBAL_FASHION@v1

# Safety valves
SKIP_DB_MIGRATIONS=false
CATEGORY_MIN_PRODUCT_COUNT=1

# Set to 'false' to force fallback to legacy merchant-derived categories.
TAXONOMY_ENABLED=true

# ---------------- Look Replicator (agent task) ----------------
# Used by the Look Replicate Share app:
# - POST /uploads/signed-url
# - POST /look-jobs
# - GET  /look-jobs/:jobId
# - GET  /shares/:shareId
#
# Auth: send `Authorization: Bearer <LOOK_REPLICATOR_API_KEY>`
LOOK_REPLICATOR_API_KEY=

# Upload policy
LOOK_REPLICATOR_MAX_UPLOAD_BYTES=26214400
LOOK_REPLICATOR_SIGNED_URL_TTL_SECONDS=300

# S3-compatible storage (Cloudflare R2 recommended)
LOOK_REPLICATOR_S3_ENDPOINT=
LOOK_REPLICATOR_S3_REGION=auto
LOOK_REPLICATOR_S3_BUCKET=
LOOK_REPLICATOR_S3_ACCESS_KEY_ID=
LOOK_REPLICATOR_S3_SECRET_ACCESS_KEY=

# Public base URL used to form `publicUrl` returned to the browser
LOOK_REPLICATOR_PUBLIC_ASSET_BASE_URL=

# ---------------- Multilingual Vector Recall (Route B) ----------------
# Enable hybrid recall (lexical + vector) for creator cache search.
FIND_PRODUCTS_MULTI_VECTOR_ENABLED=false

# ---------------- Catalog Auto Sync ----------------
# Enables periodic Shopify->products_cache refresh via pivota-backend internal sync API.
# Defaults to enabled in production when unset. Set explicitly to `false` to disable.
CREATOR_CATALOG_AUTO_SYNC_ENABLED=
# Optional explicit merchant scope override (comma-separated).
# If unset, gateway auto-discovers approved+connected merchants server-side.
CATALOG_SYNC_MERCHANT_IDS=
# Optional: enable non-shopify fallback discovery (merchant_onboarding/products_cache).
# Default strict mode is false (only sync merchants with active Shopify store credentials).
CATALOG_SYNC_DISCOVERY_RELAXED=false
# Sync cadence guardrail:
# effective_interval_minutes = min(configured_or_default, min(360, floor(CREATOR_CATALOG_CACHE_TTL_SECONDS/4/60)))
CREATOR_CATALOG_AUTO_SYNC_INTERVAL_MINUTES=
CREATOR_CATALOG_AUTO_SYNC_INITIAL_DELAY_MS=15000
CREATOR_CATALOG_AUTO_SYNC_LIMIT=200
# TTL applied to synced products_cache rows.
CREATOR_CATALOG_CACHE_TTL_SECONDS=604800
# Optional dedicated admin key; falls back to ADMIN_API_KEY when unset.
CREATOR_CATALOG_SYNC_ADMIN_KEY=

# ---------------- Aurora BFF (/v1) ----------------
# BFF/Orchestrator for https://aurora.pivota.cc (Lifecycle Skincare Partner)
#
# Upstream Aurora decision system base URL (knowledge + reasoning).
# If unset, /v1/chat will return a gated fallback response.
AURORA_DECISION_BASE_URL=
#
# pivota-backend base URL for offers/checkout (external outbound preferred).
# If unset, /v1/offers/resolve will return `field_missing` with reason `pivota_backend_not_configured`.
PIVOTA_BACKEND_BASE_URL=
#
# CORS allowlist (comma-separated). Must include https://aurora.pivota.cc in production.
ALLOWED_ORIGINS=
#
# Auto-run DB migrations on boot (only when NODE_ENV=production and DATABASE_URL is set).
# Set to 'false' to disable.
DB_AUTO_MIGRATE=true
#
# Dev/test flags (do NOT enable in prod unless intended).
AURORA_BFF_USE_MOCK=false
AURORA_BFF_INCLUDE_RAW_CONTEXT=false
#
# Reco PDP test mode: when enabled, product recommendations are sourced from Pivota product search
# (grounded product_id/merchant_id), so the Aurora chatbox can reliably open PDP pages.
# Turn off to revert to normal (Aurora Decision System) recommendations.
AURORA_BFF_RECO_CATALOG_GROUNDED=false
# Optional override (comma-separated). Default: cleanser,moisturizer,sunscreen
AURORA_BFF_RECO_CATALOG_QUERIES=

# Skin photo analysis (Vision)
# Enables pivota-agent to fetch a short-lived GET URL from pivota-backend and run a
# cautious, non-medical skin assessment using a multimodal LLM.
# Requires:
# - pivota-backend supports GET /photos/download-url?upload_id=...
# - OPENAI_API_KEY is configured
AURORA_SKIN_VISION_ENABLED=false
AURORA_SKIN_VISION_MODEL=gpt-4o-mini
AURORA_SKIN_VISION_TIMEOUT_MS=12000

# Photo upload proxy (avoid browser->storage CORS)
# When the chatbox uploads photos via pivota-agent (multipart/form-data), this caps max bytes.
AURORA_PHOTO_UPLOAD_MAX_BYTES=10485760
# Download URL fetch robustness (upload -> analysis bridge)
# - download-url generation request timeout
AURORA_PHOTO_DOWNLOAD_URL_TIMEOUT_MS=5000
# - signed URL per-attempt timeout
AURORA_PHOTO_FETCH_TIMEOUT_MS=3000
# - signed URL total timeout budget (includes retry backoff)
AURORA_PHOTO_FETCH_TOTAL_TIMEOUT_MS=5000
# - signed URL retries (2 => total attempts = 3)
AURORA_PHOTO_FETCH_RETRIES=2
# - exponential backoff base for retries
AURORA_PHOTO_FETCH_RETRY_BASE_MS=250
# In-memory short-lived photo byte cache (uid + photo_id scoped)
AURORA_PHOTO_CACHE_MAX_ITEMS=40
AURORA_PHOTO_CACHE_TTL_MS=600000

# ---------------- Diagnosis Shadow Verifier (Gemini) ----------------
# Keep OFF by default; enable only for shadow validation rollout.
DIAG_GEMINI_VERIFY=false
DIAG_GEMINI_VERIFY_MODEL=gemini-2.0-flash
# Timeout for verifier provider calls (ms). Overrides legacy DIAG_GEMINI_VERIFY_TIMEOUT_MS when set.
DIAG_VERIFY_TIMEOUT_MS=12000
DIAG_GEMINI_VERIFY_RETRIES=1
DIAG_GEMINI_VERIFY_IOU_THRESHOLD=0.3
DIAG_GEMINI_VERIFY_HARD_CASE_THRESHOLD=0.55
# Budget guardrails (0 means unlimited for that window)
DIAG_VERIFY_MAX_CALLS_PER_MIN=0
DIAG_VERIFY_MAX_CALLS_PER_DAY=0
# Hard-case sink (structured outputs only, no raw image bytes)
DIAG_GEMINI_VERIFY_HARD_CASE_PATH=tmp/diag_verify/hard_cases.ndjson

# ---------------- Pseudo-label factory ----------------
# Enable/disable pseudo-label persistence and daily job input files.
AURORA_PSEUDO_LABEL_ENABLED=true
# Store directory for model_outputs / agreement_samples / pseudo_labels.
AURORA_PSEUDO_LABEL_DIR=tmp/diag_pseudo_label_factory
# Allow ROI payload storage (default false to keep storage image-free).
AURORA_PSEUDO_LABEL_ALLOW_ROI=false
# Region IoU gate for pseudo-label matching.
AURORA_PSEUDO_LABEL_REGION_IOU_THRESHOLD=0.3
# Minimum agreement score Ï„ for pseudo label emission.
# New canonical env key:
AURORA_PSEUDO_LABEL_MIN_AGREEMENT=0.75
# Legacy alias kept for backward compatibility.
AURORA_PSEUDO_LABEL_AGREEMENT_THRESHOLD=0.75

# ---------------- Calibration runtime ----------------
# Keep OFF by default; enable after calibrator artifacts are validated.
DIAG_CALIBRATION_ENABLED=false
# Optional explicit model path. If empty, loader uses latest calibrator_v*.json when allowed.
DIAG_CALIBRATION_MODEL_PATH=model_registry/diag_calibration_v1.json
# Prefer latest model_registry/calibrator_vYYYYMMDD.json when true and explicit path is not set.
DIAG_CALIBRATION_USE_LATEST_VERSION=true

# Embeddings provider config (Gemini recommended as multilingual default).
PIVOTA_EMBEDDINGS_PROVIDER=gemini
PIVOTA_EMBEDDINGS_FALLBACK_PROVIDER=

# Gemini embeddings
GEMINI_API_KEY=
GEMINI_BASE_URL=https://generativelanguage.googleapis.com
PIVOTA_EMBEDDINGS_MODEL_GEMINI=text-embedding-004

# OpenAI embeddings (optional)
PIVOTA_EMBEDDINGS_MODEL_OPENAI=text-embedding-3-small

# Embeddings runtime knobs
PIVOTA_EMBEDDINGS_CACHE_TTL_MS=300000
PIVOTA_EMBEDDINGS_MAX_CHARS=6000
PIVOTA_EMBEDDINGS_BATCH_SIZE=16
PIVOTA_EMBEDDINGS_UPSERT_BATCH_SIZE=32

# ---------------- Look Replicator (OpenAI-compatible proxy) ----------------
# If you use an OpenAI-compatible Gemini proxy, point these envs to the proxy:
# OPENAI_BASE_URL=https://<proxy-base>          (WITHOUT trailing /v1)
# OPENAI_API_KEY=<proxy-key>
#
# Enable OpenAI-compatible proxy for look-replicator endpoints:
# LOOK_REPLICATOR_ONE_CLICK_PROVIDER=openai
# LOOK_REPLICATOR_TRYON_PROVIDER=openai
#
# Choose models (must support multimodal inputs for one-click/try-on):
# LOOK_REPLICATOR_ONE_CLICK_MODEL_OPENAI=<model>
# LOOK_REPLICATOR_TRYON_MODEL_OPENAI=<model>
