{
  "assumptions": [
    "Canonical trigger key paths are dot-separated strings evaluated against a single request payload that contains look_spec (LookSpecV0), user_face_profile (FaceProfileV0), ref_face_profile (FaceProfileV0), and similarity_report (SimilarityReportV0).",
    "LookSpecV0 supports an explicit 'unknown' bucket for enums to avoid breaking validation when upstream inference is uncertain.",
    "Liner degree is signed (negative = downturned, positive = upturned) and is interpreted consistently across markets.",
    "FaceProfileV0 quality/occlusion/pose values are either numeric in [0,1] or bucketed enums; where uncertain, keys are placed into optional_future.",
    "SimilarityReportV0 contains per-area deltas (base/eye/lip/vibe_tags) and warnings/confidence outputs; where uncertain, keys are placed into optional_future.",
    "JP and US Market Packs are isolated at the data layer, but triggers operate on the same market-neutral key names; market-specific logic should be expressed via vibe_tags and TechniqueCard market scoping rather than different trigger keys."
  ],
  "trigger_key_whitelist": {
    "lookSpec": [
      "look_spec.base.finish",
      "look_spec.base.coverage",
      "look_spec.eye.shadow_shape",
      "look_spec.eye.liner_direction.direction",
      "look_spec.eye.liner_direction.degree",
      "look_spec.eye.lash_intensity",
      "look_spec.lip.finish",
      "look_spec.lip.hue.model",
      "look_spec.lip.hue.h",
      "look_spec.lip.hue.s",
      "look_spec.lip.hue.v",
      "look_spec.vibe_tags"
    ],
    "faceProfile_user": [
      "user_face_profile.quality.score",
      "user_face_profile.quality.blur_score",
      "user_face_profile.quality.noise_score",
      "user_face_profile.pose.yaw_deg",
      "user_face_profile.pose.pitch_deg",
      "user_face_profile.pose.roll_deg",
      "user_face_profile.pose.is_frontal",
      "user_face_profile.occlusion.face_occlusion_score",
      "user_face_profile.occlusion.eye_occlusion_score",
      "user_face_profile.occlusion.lip_occlusion_score",
      "user_face_profile.lighting.exposure_score",
      "user_face_profile.lighting.white_balance_score"
    ],
    "faceProfile_ref": [
      "ref_face_profile.quality.score",
      "ref_face_profile.quality.blur_score",
      "ref_face_profile.quality.noise_score",
      "ref_face_profile.pose.yaw_deg",
      "ref_face_profile.pose.pitch_deg",
      "ref_face_profile.pose.roll_deg",
      "ref_face_profile.pose.is_frontal",
      "ref_face_profile.occlusion.face_occlusion_score",
      "ref_face_profile.occlusion.eye_occlusion_score",
      "ref_face_profile.occlusion.lip_occlusion_score",
      "ref_face_profile.lighting.exposure_score",
      "ref_face_profile.lighting.white_balance_score"
    ],
    "similarity": [
      "similarity_report.overall.score",
      "similarity_report.overall.confidence",
      "similarity_report.base.delta_finish",
      "similarity_report.base.delta_coverage",
      "similarity_report.eye.delta_shadow_shape",
      "similarity_report.eye.delta_liner_direction",
      "similarity_report.eye.delta_liner_degree",
      "similarity_report.eye.delta_lash_intensity",
      "similarity_report.lip.delta_finish",
      "similarity_report.lip.delta_hue_distance",
      "similarity_report.vibe_tags.overlap_score",
      "similarity_report.warnings"
    ],
    "optional_future": [
      "user_face_profile.geometry.face_shape_bucket",
      "user_face_profile.geometry.eye_shape_bucket",
      "user_face_profile.geometry.lid_type_bucket",
      "user_face_profile.geometry.lip_volume_bucket",
      "user_face_profile.skin.skin_type_bucket",
      "user_face_profile.skin.undertone_bucket",
      "ref_face_profile.geometry.face_shape_bucket",
      "ref_face_profile.geometry.eye_shape_bucket",
      "ref_face_profile.geometry.lid_type_bucket",
      "ref_face_profile.geometry.lip_volume_bucket",
      "ref_face_profile.skin.skin_type_bucket",
      "ref_face_profile.skin.undertone_bucket",
      "similarity_report.base.delta_texture",
      "similarity_report.base.delta_luminosity",
      "similarity_report.eye.delta_openness",
      "similarity_report.eye.delta_roundness",
      "similarity_report.lip.delta_saturation",
      "similarity_report.lip.delta_value",
      "similarity_report.debug"
    ]
  },
  "do_not_use_in_triggers": [
    "similarity_report.warnings",
    "similarity_report.debug",
    "user_face_profile.raw_landmarks",
    "ref_face_profile.raw_landmarks",
    "user_face_profile.image_hash",
    "ref_face_profile.image_hash",
    "any_freeform_text_fields",
    "any_model_version_fields",
    "any_latency_or_runtime_fields",
    "confidence_levels_or_confidence_maps"
  ],
  "confidence_convention": {
    "levels": [
      "high",
      "medium",
      "low"
    ],
    "rules": [
      {
        "field": "look_spec.base.finish",
        "when": "user_face_profile.quality.score < 0.4 OR user_face_profile.occlusion.face_occlusion_score > 0.6",
        "level": "low"
      },
      {
        "field": "look_spec.base.coverage",
        "when": "user_face_profile.quality.score < 0.4 OR user_face_profile.lighting.exposure_score < 0.3",
        "level": "low"
      },
      {
        "field": "look_spec.eye.shadow_shape",
        "when": "user_face_profile.occlusion.eye_occlusion_score > 0.5 OR user_face_profile.pose.is_frontal == false",
        "level": "low"
      },
      {
        "field": "look_spec.eye.liner_direction.direction",
        "when": "user_face_profile.occlusion.eye_occlusion_score > 0.5 OR ABS(user_face_profile.pose.yaw_deg) > 20 OR ABS(user_face_profile.pose.pitch_deg) > 20",
        "level": "low"
      },
      {
        "field": "look_spec.eye.liner_direction.degree",
        "when": "look_spec.eye.liner_direction.direction == 'unknown'",
        "level": "low"
      },
      {
        "field": "look_spec.eye.lash_intensity",
        "when": "user_face_profile.occlusion.eye_occlusion_score > 0.5 OR user_face_profile.quality.blur_score > 0.6",
        "level": "low"
      },
      {
        "field": "look_spec.lip.finish",
        "when": "user_face_profile.occlusion.lip_occlusion_score > 0.5 OR user_face_profile.quality.score < 0.4",
        "level": "low"
      },
      {
        "field": "look_spec.lip.hue",
        "when": "user_face_profile.occlusion.lip_occlusion_score > 0.5 OR user_face_profile.lighting.white_balance_score < 0.4 OR user_face_profile.lighting.exposure_score < 0.3",
        "level": "low"
      },
      {
        "field": "look_spec.vibe_tags",
        "when": "similarity_report.overall.confidence == 'low' OR 'LOW_SIGNAL' in similarity_report.warnings",
        "level": "low"
      },
      {
        "field": "all_fields",
        "when": "user_face_profile.quality.score >= 0.7 AND user_face_profile.pose.is_frontal == true AND user_face_profile.occlusion.face_occlusion_score <= 0.3",
        "level": "high"
      },
      {
        "field": "all_fields",
        "when": "otherwise",
        "level": "medium"
      }
    ],
    "notes": [
      "Confidence is advisory metadata: it should not directly gate TechniqueCard triggers in P0 (see do_not_use_in_triggers).",
      "If SimilarityReportV0 already emits a field-level confidence map, this convention should be implemented as a thin mapping layer without changing upstream scoring."
    ]
  },
  "notes": [
    "Trigger keys are deliberately limited to stable, semantically meaningful fields; avoid adding numeric thresholds on high-variance signals until they are proven stable and well-calibrated.",
    "Market neutrality is achieved by keeping keys identical and scoping market differences via market packs, vibe_tags dictionaries, and technique selectionâ€”not by different trigger schemas per market.",
    "The 'unknown' bucket pattern is used to prevent forced classification; this reduces refactor risk when adding future buckets."
  ],
  "open_questions": [
    "What are the exact FaceProfileV0 field names and ranges for quality, blur, noise, occlusion, lighting, and pose? If they differ, we should adjust the whitelist to match reality and move mismatched keys into optional_future.",
    "Does SimilarityReportV0 encode confidence as a string (high/medium/low) or numeric? If numeric, what is its range and recommended thresholds for mapping to levels?",
    "Do we want to allow triggers directly on lip.hue.* values in P0, or should hue-based triggers be deferred to optional_future to avoid instability from lighting/WB variation?",
    "Should TechniqueCard triggers support comparison operators (gt/lt/between) for numeric fields, or should P0 only allow eq/in/has_any with numeric handled via pre-bucketization upstream?"
  ]
}